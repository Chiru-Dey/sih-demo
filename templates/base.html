{# Ensure user_preferences is always available with defaults #}
{% if not user_preferences %}
{% set user_preferences = {
'dark_mode': False,
'high_contrast': False,
'font_size': 16,
'language': 'en',
'notifications': True,
'location_services': True
} %}
{% endif %}
<!DOCTYPE html>
<html lang="{{ current_language or 'en' }}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Disastrous - Disaster Management App{% endblock %}</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" id="theme-color-meta" content="#5978f3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Disastrous">
    <meta name="msapplication-TileColor" id="ms-tile-color-meta" content="#11151c">

    <!-- PWA Manifest -->
    <link rel="manifest" href="{{ url_for('manifest') }}">

    <!-- PWA Icons -->
    <link rel="icon" type="image/jpeg" sizes="192x192" href="{{ url_for('static', filename='disastrous_logo.jpg') }}">

    <!-- External CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <!-- Internal CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/map.css') }}">

    <!-- Additional page-specific styles -->
    {% block styles %}{% endblock %}
</head>

<body
    class="{% if user_preferences.get('dark_mode', False) %}dark-mode{% endif %} {% if user_preferences.get('high_contrast', False) %}high-contrast{% endif %} {% block body_class %}{% endblock %}"
    style="font-size: {{ user_preferences.get('font_size', 16) }}px;"
    data-language="{{ user_preferences.get('language', 'en') }}"
    data-font-size="{{ user_preferences.get('font_size', 16) }}"
    data-high-contrast="{{ 'true' if user_preferences.get('high_contrast', False) else 'false' }}"
    data-dark-mode="{{ 'true' if user_preferences.get('dark_mode', False) else 'false' }}">

    <!-- Emergency Alert Block -->
    {% block emergency_alert %}
    {% include 'components/emergency_alert.html' %}
    {% endblock %}

    <!-- Skip to Content Link -->
    <a href="#main-content" class="skip-to-content">Skip to main content</a>

    <!-- PWA Install Banner -->
    <div class="pwa-install-banner" id="pwaInstallBanner">
        <i class="fas fa-download"></i>
        <div class="pwa-install-text">
            <strong>Install Disastrous</strong><br>
            Get quick access to disaster alerts and emergency services!
        </div>
        <button class="btn-primary" id="pwaInstallBtn">Install</button>
        <button class="btn-secondary" onclick="hidePWABanner()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator">
        <i class="fas fa-wifi"></i> You're offline - Limited functionality available
    </div>

    <!-- Translation Panel Component -->
    {% block translation_panel %}
    {% include 'components/translation_panel.html' %}
    {% endblock %}

    <!-- Accessibility Panel Component -->
    {% block accessibility_panel %}
    {% include 'components/accessibility_panel.html' %}
    {% endblock %}

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <button class="hamburger">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo-section">
                <img src="{{ url_for('static', filename='disastrous_logo.jpg') }}" alt="Disastrous Logo" class="logo"
                    data-no-translate>
                <h1 class="app-name">Disastrous</h1>
            </div>
        </div>
    </header>

    <!-- Main Content Block -->
    <main class="main-content" id="main-content">
        {% block content %}{% endblock %}
    </main>

    <!-- Fixed Action Buttons -->
    {% block fixed_actions %}
    <div class="fixed-actions">
        <button class="action-btn sos-button" id="sosButton" onclick="makeEmergencyCall()"
            aria-label="Emergency SOS Button">
            <strong>SOS</strong>
        </button>
        <button class="action-btn ai-assistant" onclick="openAIAssistant()">
            <i class="fas fa-robot"></i>
        </button>
        <button class="action-btn quick-chat" onclick="startQuickChat()">
            <i class="fas fa-comments"></i>
        </button>
    </div>
    {% endblock %}

    <!-- Chat Modals Component -->
    {% include 'components/chat_modals.html' %}

    <!-- SOS Modal -->
    <dialog class="sos-modal" id="sosModal">
        <div class="modal-content">
            <h2>Send SOS Message</h2>
            <form id="sosForm">
                <div class="form-group">
                    <label for="sosName">Your Name (Optional)</label>
                    <input type="text" id="sosName" name="name" placeholder="Enter your name">
                </div>
                <div class="form-group">
                    <label for="sosContact">Contact Number*</label>
                    <input type="tel" id="sosContact" name="contact" placeholder="Enter contact number" required>
                </div>
                <div class="form-group">
                    <label for="sosMessage">Emergency Message*</label>
                    <textarea id="sosMessage" name="message" placeholder="Describe your emergency situation"
                        required></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="shareLocation" name="shareLocation" checked>
                        Share my location to help emergency services find me
                    </label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeSosModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Send SOS</button>
                </div>
            </form>
        </div>
    </dialog>

    <!-- Role-specific Navigation Menu -->
    {% if session.get('user_role') == 'admin' %}
    {% include 'components/admin_menu.html' %}
    {% elif session.get('user_role') == 'rescue' %}
    {% include 'components/rescue_menu.html' %}
    {% else %}
    {% include 'components/navigation_menu.html' %}
    {% endif %}

    <!-- Leaflet.js -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <!-- Backend Integration Script -->
    <script type="module">
        const aiAvailable = "{{ ai_available }}" === "true";
        const mapsApiKey = "{{ maps_key }}";

        if (aiAvailable) {
            window.aiAvailable = true;
            console.log("✅ A4F AI (Backend) initialized successfully");
        } else {
            window.aiAvailable = false;
            console.log("⚠️ A4F API key not configured");
        }

        // Initialize Leaflet map on page load
        window.mapsAvailable = true;
        console.log("✅ Leaflet maps initialized");
    </script>


    <!-- Core JavaScript -->
    <script src="{{ url_for('static', filename='js/base.js') }}?v={{ now }}"></script>
    <script src="{{ url_for('static', filename='js/components/translation.js') }}?v={{ now }}"></script>
    <script src="{{ url_for('static', filename='js/components/accessibility.js') }}?v={{ now }}"></script>
    <script src="{{ url_for('static', filename='js/components/chatbot.js') }}?v={{ now }}"></script>
    <script src="{{ url_for('static', filename='js/components/pwa.js') }}?v={{ now }}"></script>
    <script src="{{ url_for('static', filename='js/collapsible.js') }}?v={{ now }}"></script>
    <script src="{{ url_for('static', filename='js/components/map.js') }}?v={{ now }}"></script>

    <!-- Additional page-specific scripts -->
    {% block scripts %}{% endblock %}
</body>

</html>